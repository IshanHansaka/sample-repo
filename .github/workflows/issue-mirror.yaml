name: Incident Mirror Sync

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  mirror_handler:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm init -y
          npm install @actions/core @actions/github

      - name: Create and Run Sync Script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_CONTEXT: ${{ toJson(github.event.issue) }}
          REPO_CONTEXT: ${{ toJson(github.repository) }}
        run: |
          # 1. Ensure the directory exists
          mkdir -p scripts

          # 2. Generate the JS file INSTANTLY (Fixes missing file error)
          cat << 'EOF' > scripts/sync-incident.js
          
          // --- FIX: Use deep imports to bypass Node 20 export errors ---
          const core = require('@actions/core/lib/core');
          const github = require('@actions/github/lib/github');
          // -----------------------------------------------------------

          async function run() {
              try {
                  console.log("üöÄ SCRIPT STARTED SUCCESSFULLY!");

                  // Get the data passed from YAML
                  const issueContext = process.env.ISSUE_CONTEXT;
                  const repoContext = process.env.REPO_CONTEXT;

                  if (!issueContext) {
                      throw new Error("Missing ISSUE_CONTEXT");
                  }

                  const issue = JSON.parse(issueContext);
                  
                  // Extract Data
                  const title = issue.title;
                  const description = issue.body || "";
                  const url = issue.html_url;
                  const labels = issue.labels ? issue.labels.map(l => l.name) : [];

                  console.log(`\n--- üì• Incoming Incident Detected ---`);
                  console.log(`Title:      ${title}`);
                  console.log(`Labels:     ${labels.join(', ')}`);
                  console.log(`Link:       ${url}`);
                  console.log(`-------------------------------------\n`);

                  // Google Doc Logic
                  const googleDocRegex = /docs\.google\.com\/document\/d\/([a-zA-Z0-9-_]+)/;
                  const match = description.match(googleDocRegex);

                  if (match && match[1]) {
                      console.log(`‚úÖ SECURITY REPORT FOUND`);
                      console.log(`   Doc ID: ${match[1]}`);
                      console.log(`   (Ready for Milestone 2: Google API Fetch)`);
                  } else {
                      console.log(`‚ö†Ô∏è NO SECURITY REPORT ATTACHED`);
                  }

              } catch (error) {
                  core.setFailed(`Action Failed: ${error.message}`);
              }
          }

          run();
          EOF
          
          # 3. Run the file we just created
          node scripts/sync-incident.js